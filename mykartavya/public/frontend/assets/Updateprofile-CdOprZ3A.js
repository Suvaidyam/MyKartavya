var x=(E,_,f)=>new Promise((c,d)=>{var w=l=>{try{y(f.next(l))}catch(h){d(h)}},o=l=>{try{y(f.throw(l))}catch(h){d(h)}},y=l=>l.done?c(l.value):Promise.resolve(l.value).then(w,o);y((f=f.apply(E,_)).next())});import{i as I,r as m,C as Y,l as z,o as H,c as r,b as n,d as a,m as b,s as D,f as T,v as O,t as g,F as B,h as U,u as V,n as L,z as G,e as Z,y as J,D as K,E as Q,G as W}from"./index-C8FGMhp8.js";import{_ as X}from"./Rectangle-Cxb5RPqE.js";import{l as p}from"./index-Ciqh-vHB.js";const ee={key:0,class:"max-w-md"},te={class:"mb-4"},ae=["disabled"],oe={key:0,class:"text-red-500 text-[11px] mt-1"},se={key:0,class:"mb-4 p-4 bg-green-50 border border-green-200 rounded-md"},le=["disabled"],re=["disabled"],ne={key:0,class:"inline-block animate-spin w-4 h-4"},ie={key:1,class:"mt-6"},ue={class:"space-y-4"},ce={key:0,class:"text-gray-500 text-center py-8"},de={class:"font-medium"},me={class:"text-sm text-gray-600"},pe={class:"text-xs text-gray-500"},ve=["onClick"],fe={key:2,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"},ye={class:"bg-white rounded-lg p-6 max-w-sm w-full mx-4"},be={class:"flex justify-end gap-3"},ge={__name:"CompanyMapping",setup(E){const _=I("call"),f=I("auth"),c=m(""),d=m(!1),w=m(!1),o=m(""),y=m(0),l=m([]),h=m(!1),C=m(!1),P=m(null),$=Y(()=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(c.value)),S=()=>x(this,null,function*(){var v;if(A())try{if(h.value=!0,o.value="",!$.value){o.value="Please enter a valid email address";return}(yield _("frappe.client.insert",{doc:{doctype:"Volunteer Company Mapper",volunteer_email:c.value,volunteer:f.cookie.name}}))&&(d.value=!0,q(),p.success("Verification email sent! Please check your inbox."))}catch(e){const t=((v=e==null?void 0:e.message)==null?void 0:v.toLowerCase())||"";t.includes("email not found in sva user")?(o.value="This email is not registered in our system. Please use your company email address.",p.error("Invalid company email address")):t.includes("no company associated")?(o.value="No company is associated with this email. Please contact your company administrator.",p.error("No company association found")):t.includes("already exists")?(o.value="This email is already mapped to a company. Please use a different email.",p.error("Email already mapped")):t.includes("verification required")?(d.value=!0,q(),p.info("A verification email has already been sent. Please check your inbox.")):t.includes("rate limit")?(o.value="Please wait a few minutes before requesting another verification email.",p.warning("Too many attempts. Please wait.")):(o.value="An error occurred while processing your request. Please try again later.",p.error("Failed to process request"),console.error("Company mapping error:",e))}finally{h.value=!1}}),R=()=>{y.value===0&&S()},q=()=>{y.value=300;const v=setInterval(()=>{y.value>0?y.value--:clearInterval(v)},1e3)},j=()=>{c.value="",d.value=!1,w.value=!1,o.value=""},N=v=>{P.value=v,C.value=!0},F=()=>x(this,null,function*(){var v;try{yield _("frappe.client.delete",{doctype:"Volunteer Company Mapper",name:P.value}),p.success("Company mapping removed successfully!"),yield M()}catch(e){const t=((v=e==null?void 0:e.message)==null?void 0:v.toLowerCase())||"";t.includes("permission")?p.error("You do not have permission to remove this mapping"):t.includes("not found")?(p.error("This mapping no longer exists"),yield M()):(p.error("Failed to remove company mapping"),console.error("Remove mapping error:",e))}finally{C.value=!1,P.value=null}}),M=()=>x(this,null,function*(){var v;try{const e=yield _("frappe.client.get_list",{doctype:"Volunteer Company Mapper",fields:["name","volunteer_email","company_name","role_profile"],filters:{volunteer:f.cookie.name,is_email_verified:1}});l.value=e||[],w.value=l.value.length>0}catch(e){(((v=e==null?void 0:e.message)==null?void 0:v.toLowerCase())||"").includes("permission")?p.error("You do not have permission to view company mappings"):(p.error("Failed to fetch company mappings"),console.error("Fetch mappings error:",e)),l.value=[],w.value=!1}}),A=()=>(o.value="",c.value?$.value?c.value.includes("@gmail.com")||c.value.includes("@yahoo.com")||c.value.includes("@hotmail.com")?(o.value="Please use your company email address",!1):!0:(o.value="Please enter a valid email address",!1):(o.value="Email address is required",!1));return z(c,()=>{c.value&&!$.value?o.value="Please enter a valid email address":o.value=""}),H(()=>{M()}),(v,e)=>(n(),r("div",null,[e[8]||(e[8]=a("h2",{class:"text-xl font-semibold text-gray-700 mb-4"},"Company Mapping",-1)),w.value?(n(),r("div",ie,[a("div",{class:"flex justify-between items-center mb-4"},[e[5]||(e[5]=a("h3",{class:"text-lg font-medium text-gray-700"},"Mapped Companies",-1)),a("button",{onClick:j,class:"text-orange-500 hover:text-orange-600 text-sm"}," + Map New Company ")]),a("div",ue,[l.value.length===0?(n(),r("div",ce," No companies mapped yet ")):b("",!0),(n(!0),r(B,null,U(l.value,t=>(n(),r("div",{key:t.name,class:"flex justify-between items-center p-4 bg-gray-50 rounded-lg"},[a("div",null,[a("p",de,g(t.company_name),1),a("p",me,g(t.volunteer_email),1),a("p",pe,"Role: "+g(t.role_profile),1)]),a("button",{onClick:s=>N(t.name),class:"text-red-500 hover:text-red-600"}," Remove ",8,ve)]))),128))])])):(n(),r("div",ee,[a("div",te,[e[2]||(e[2]=a("label",{class:"block text-bodyh1 font-normal text-gray-700 mb-1"},[T(" Company Email "),a("span",{class:"text-red-500"},"*")],-1)),D(a("input",{"onUpdate:modelValue":e[0]||(e[0]=t=>c.value=t),type:"email",placeholder:"Enter your company email",disabled:d.value,class:"block w-full border border-gray-300 text-bodyh2 rounded py-2 px-3 focus:outline-none focus:ring focus:ring-orange-200"},null,8,ae),[[O,c.value]]),o.value?(n(),r("p",oe,g(o.value),1)):b("",!0)]),d.value?(n(),r("div",se,[e[3]||(e[3]=a("p",{class:"text-green-700 text-sm"},[a("span",{class:"font-medium"},"Verification email sent!"),a("br"),T(" Please check your email inbox and click the verification link to complete the company mapping process. ")],-1)),a("button",{onClick:R,class:"mt-2 text-orange-600 text-sm hover:text-orange-700",disabled:y.value>0},g(y.value>0?`Resend in ${y.value}s`:"Resend verification email"),9,le)])):b("",!0),a("div",null,[d.value?b("",!0):(n(),r("button",{key:0,onClick:S,disabled:!$.value||h.value,class:"bg-orange-500 text-white font-semibold py-2 px-4 rounded-sm hover:bg-orange-600 transition disabled:opacity-50 flex items-center gap-2"},[h.value?(n(),r("span",ne,e[4]||(e[4]=[a("svg",{class:"w-4 h-4",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[a("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),a("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})],-1)]))):b("",!0),T(" "+g(h.value?"Sending...":"Send Verification Email"),1)],8,re))])])),C.value?(n(),r("div",fe,[a("div",ye,[e[6]||(e[6]=a("h3",{class:"text-lg font-medium text-gray-900 mb-3"},"Confirm Removal",-1)),e[7]||(e[7]=a("p",{class:"text-gray-600 mb-6"},"Are you sure you want to remove this company mapping?",-1)),a("div",be,[a("button",{onClick:e[1]||(e[1]=t=>C.value=!1),class:"px-4 py-2 text-gray-600 hover:text-gray-700 border border-gray-300 rounded-sm"}," Cancel "),a("button",{onClick:F,class:"px-4 py-2 bg-red-500 text-white rounded-sm hover:bg-red-600"}," Remove ")])])])):b("",!0)]))}},_e={class:"max-w-[1920px] mx-auto px-10 pt-[82px] pb-4 bg-gray-50"},he={class:"h-[261px] rounded-b-md bg-white"},xe={class:"relative"},we={class:"absolute left-8 -bottom-8"},ke={class:"w-32 h-32 rounded-full border-4 border-white overflow-hidden"},Ce=["src"],$e={key:1,class:"w-full h-full bg-gray-200 flex items-center justify-center text-[40px] text-gray-600"},Pe={class:"pt-10 px-4"},Me={class:"text-3xl font-medium"},Ve={class:"text-bodyh1 text-gray-600 mt-1"},Se={class:"bg-white rounded-lg shadow mt-4"},qe={class:"border-b border-gray-200"},De={class:"flex space-x-8 px-6","aria-label":"Tabs"},Te={class:"p-6"},Ie={key:0},Ee={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},Re={class:"block text-bodyh1 font-normal text-gray-700 mb-1"},je={key:0,class:"text-red-500 pt-2"},Ne=["onUpdate:modelValue","type","name","placeholder"],Fe=["max"],Ae=["onUpdate:modelValue","name"],ze={value:"",disabled:""},Be=["value"],Ue={key:3,class:"text-red-500 text-[11px] mt-1"},Le={key:1},Je={__name:"Updateprofile",setup(E){const _=I("call"),f=I("auth");J();const c=m(null),d=m("personal");console.log(d.value);const w=m({first_name:{label:"First Name",type:"text",required:!0,pattern:/^[A-Za-z]+$/,error_message:"Please enter a valid first name (letters only)"},last_name:{label:"Last Name",type:"text",required:!1},mobile_number:{label:"Phone No.",type:"text",required:!0,pattern:/^[0-9]{10}$/,error_message:"Invalid phone number "},custom_country:{label:"Country",type:"select",required:!0},custom_state:{label:"State",type:"select",required:!0},custom_city:{label:"City",type:"select",required:!0},custom_company:{label:"Company",type:"select",required:!1},custom_date_of_birth:{label:"Date of Birth",type:"date",required:!0,min:"1900-01-01",max:new Date().toISOString().split("T")[0],max:"maxDate",error_message:"Please select a valid date of birth"},title:{label:"Title",type:"text",placeholder:"Enter your title",required:!1}}),o=m({first_name:"",last_name:"",mobile_number:"",custom_country:"",custom_state:"",custom_city:"",custom_company:"",custom_date_of_birth:"",title:""}),y=m(new Date().toISOString().split("T")[0]),l=m({}),h=m([]),C=m([]),P=m([]),$=m([]),S=()=>x(this,null,function*(){const e=yield _("mykartavya.controllers.api.country_data");h.value=e||[]}),R=()=>x(this,null,function*(){if(!o.value.custom_country)return;const e=yield _("mykartavya.controllers.api.state_data",{country:o.value.custom_country});C.value=e||[]}),q=()=>x(this,null,function*(){if(!o.value.custom_state)return;const e=yield _("mykartavya.controllers.api.city_data",{state:o.value.custom_state});P.value=e||[]}),j=()=>x(this,null,function*(){const e=yield _("mykartavya.controllers.api.company_data");$.value=e||[]});z(()=>o.value.custom_country,R),z(()=>o.value.custom_state,q);const N=()=>x(this,null,function*(){let e=yield _("mykartavya.controllers.api.sva_user_data");e&&e.length>0&&(o.value=e[0],o.value.custom_company&&d.value==="company"&&(d.value="personal"))}),F=()=>{var t;l.value={};let e=!0;for(const s in o.value){const i=w.value[s],u=o.value[s];if(i){if(i.required&&!u&&(l.value[s]=`${i.label} is required.`,e=!1,c.value||(c.value=s)),s==="mobile_number"){const k=u==null?void 0:u.trim();(t=i.pattern)!=null&&t.test(k)||((k==null?void 0:k.length)===0?l.value[s]="Phone number is required.":(k==null?void 0:k.length)!==10?l.value[s]="Phone number must be exactly 10 digits.":l.value[s]=i.error_message,e=!1)}console.log(u),s==="first_name"&&i.pattern&&!i.pattern.test(u)&&(l.value[s]=i.error_message,e=!1),s==="last_name"&&i.pattern&&!i.pattern.test(u)&&(l.value[s]=i.error_message,e=!1),s==="custom_date_of_birth"&&(u?new Date(u)>new Date?(l.value[s]="You cannot select a future date.",e=!1):delete l.value[s]:(l.value[s]="Date of birth is required.",e=!1))}}return e},M=()=>x(this,null,function*(){if(!F()){v();return}try{let e=yield _("mykartavya.controllers.api.update_sva_user",{data:{first_name:o.value.first_name,last_name:o.value.last_name||"",mobile_number:o.value.mobile_number,custom_date_of_birth:o.value.custom_date_of_birth,custom_country:o.value.custom_country,custom_state:o.value.custom_state,custom_city:o.value.custom_city,custom_company:o.value.custom_company||""}});e.status==200?p.success("Profile updated successfully!",{autoClose:3e3}):p.error(e.message||"Failed to update profile.")}catch(e){p.error("An error occurred while updating the profile.")}}),A=e=>{switch(e){case"custom_country":return h.value.map(t=>({name:t.name,label:t.label||t.name}));case"custom_state":return C.value.map(t=>({name:t.name,label:t.state_name||t.name}));case"custom_city":return P.value.map(t=>({name:t.name,label:t.district_name||t.name}));case"custom_company":return $.value.map(t=>({name:t.name,label:t.company_name||t.name}));default:return[]}};H(()=>{S(),j(),N(),localStorage.getItem("updateprofile")=="true"&&(p.error("Please update your profile to continue.",{autoClose:3e3}),localStorage.removeItem("updateprofile"))});const v=()=>x(this,null,function*(){if(c.value){yield W();const e=document.querySelector(`[name="${c.value}"]`);e&&(e.scrollIntoView({behavior:"smooth",block:"center"}),e.focus()),c.value=null}});return(e,t)=>(n(),r("div",_e,[a("div",he,[a("div",xe,[t[7]||(t[7]=a("div",{class:"w-full h-[152px]"},[a("img",{src:X,alt:"Banner",class:"w-full h-full object-cover"})],-1)),a("div",we,[a("div",ke,[V(f).user_image?(n(),r("img",{key:0,src:V(f).user_image,alt:"Profile",class:"w-full h-full object-cover"},null,8,Ce)):(n(),r("div",$e,g(V(f).cookie.full_name.charAt(0)),1))])])]),a("div",Pe,[a("h1",Me,g(V(f).cookie.full_name),1),a("p",Ve,g(V(f).cookie.user_id),1)])]),a("div",Se,[a("div",qe,[a("nav",De,[a("button",{onClick:t[0]||(t[0]=s=>d.value="personal"),class:L([d.value==="personal"?"border-orange-500 text-orange-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300","whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"])}," Personal Info ",2),o.value.custom_company?b("",!0):(n(),r("button",{key:0,onClick:t[1]||(t[1]=s=>d.value="company"),class:L([d.value==="company"?"border-orange-500 text-orange-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300","whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"])}," Company Mapping ",2))])]),a("div",Te,[d.value==="personal"?(n(),r("div",Ie,[t[15]||(t[15]=a("h2",{class:"text-xl font-semibold text-gray-700 mb-4"},"Personal Info",-1)),a("form",{onSubmit:G(M,["prevent"])},[a("div",Ee,[(n(!0),r(B,null,U(w.value,(s,i)=>(n(),r("div",{key:i},[a("label",Re,[T(g(s.label)+" ",1),s.required?(n(),r("span",je,"*")):b("",!0)]),i!=="custom_date_of_birth"&&s.type!=="select"?D((n(),r("input",{key:0,"onUpdate:modelValue":u=>o.value[i]=u,type:s.type,name:i,placeholder:s.placeholder,class:"block w-full border border-gray-300 text-bodyh2 rounded py-2 px-3 focus:outline-none focus:ring focus:ring-orange-200"},null,8,Ne)),[[K,o.value[i]]]):i==="custom_date_of_birth"?D((n(),r("input",{key:1,"onUpdate:modelValue":t[2]||(t[2]=u=>o.value.custom_date_of_birth=u),type:"date",name:"custom_date_of_birth",max:y.value,class:"block w-full border border-gray-300 text-bodyh2 rounded py-2 px-3 focus:outline-none focus:ring focus:ring-orange-200"},null,8,Fe)),[[O,o.value.custom_date_of_birth]]):b("",!0),s.type==="select"?D((n(),r("select",{key:2,"onUpdate:modelValue":u=>o.value[i]=u,name:i,class:"block w-full border border-gray-300 text-bodyh2 rounded py-2 px-3 focus:outline-none focus:ring focus:ring-orange-200"},[a("option",ze,"Select "+g(s.label),1),(n(!0),r(B,null,U(A(i),u=>(n(),r("option",{key:u.name,value:u.name},g(u.label||u.name),9,Be))),128))],8,Ae)),[[Q,o.value[i]]]):b("",!0),l.value[i]?(n(),r("p",Ue,g(l.value[i]),1)):b("",!0)]))),128)),a("div",null,[t[10]||(t[10]=a("label",{class:"block text-bodyh1 font-normal text-gray-700 mb-1"},"Add CV",-1)),a("div",{class:"flex flex-col items-center justify-center border-2 border-dashed border-orange-300 text-orange-500 p-4 rounded cursor-pointer",onClick:t[4]||(t[4]=s=>e.cvInput.click())},[t[8]||(t[8]=a("svg",{class:"w-10 h-10 mb-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24","stroke-width":"2"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M7 3h10M7 3a2 2 0 00-2 2v2m2-2h10m0 0a2 2 0 012 2v2m-2-2H7m13 8V8H4v8a2 2 0 002 2h12a2 2 0 002-2z"})],-1)),t[9]||(t[9]=a("span",{class:"text-bodyh1"},"Click to upload or drag and drop",-1)),a("input",{ref:"cvInput",type:"file",accept:".pdf,.doc,.docx",class:"hidden",onChange:t[3]||(t[3]=(...s)=>e.onCvSelected&&e.onCvSelected(...s))},null,544)])]),a("div",null,[t[13]||(t[13]=a("label",{class:"block text-bodyh1 font-normal text-gray-700 mb-1"},"Add Portfolio",-1)),a("div",{class:"flex flex-col items-center justify-center border-2 border-dashed border-orange-300 text-orange-500 p-4 rounded cursor-pointer",onClick:t[6]||(t[6]=s=>e.portfolioInput.click())},[t[11]||(t[11]=a("svg",{class:"w-10 h-10 mb-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24","stroke-width":"2"},[a("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M7 3h10M7 3a2 2 0 00-2 2v2m2-2h10m0 0a2 2 0 012 2v2m-2-2H7m13 8V8H4v8a2 2 0 002 2h12a2 2 0 002-2z"})],-1)),t[12]||(t[12]=a("span",{class:"text-sm"},"Click to upload or drag and drop",-1)),a("input",{ref:"portfolioInput",type:"file",accept:".pdf,.doc,.docx",class:"hidden",onChange:t[5]||(t[5]=(...s)=>e.onPortfolioSelected&&e.onPortfolioSelected(...s))},null,544)])])]),t[14]||(t[14]=a("div",{class:"mt-6"},[a("button",{type:"submit",class:"bg-orange-500 text-white font-semibold py-2 px-4 rounded-sm hover:bg-orange-600 transition"}," UPDATE ")],-1))],32)])):b("",!0),d.value==="company"&&!o.value.custom_company?(n(),r("div",Le,[Z(ge)])):b("",!0)])])]))}};export{Je as default};
