var k=(F,h,y)=>new Promise((m,p)=>{var C=l=>{try{b(y.next(l))}catch(x){p(x)}},a=l=>{try{b(y.throw(l))}catch(x){p(x)}},b=l=>l.done?m(l.value):Promise.resolve(l.value).then(C,a);b((y=y.apply(F,h)).next())});import{i as N,r as f,C as Y,l as B,o as H,c as n,b as i,d as e,m as w,s as I,f as E,v as O,t as g,F as U,h as z,u as q,n as L,z as G,e as Z,y as J,D as K,E as Q,G as W}from"./index-Dw8UFGzE.js";import{_ as X}from"./Rectangle-Cxb5RPqE.js";import{l as v}from"./index-Cx-M-NdO.js";const ee={key:0,class:"max-w-md"},te={class:"mb-4"},ae=["disabled"],oe={key:0,class:"text-red-500 text-[11px] mt-1"},se={key:0,class:"mb-4 p-4 bg-green-50 border border-green-200 rounded-md"},re=["disabled"],le=["disabled"],ne={key:0,class:"inline-block animate-spin w-4 h-4"},ie={key:1,class:"mt-6"},ue={class:"space-y-4"},ce={key:0,class:"text-gray-500 text-center py-8"},de={class:"font-medium"},me={class:"text-sm text-gray-600"},pe={class:"text-xs text-gray-500"},ve=["onClick"],fe={__name:"CompanyMapping",setup(F){const h=N("call"),y=N("auth"),m=f(""),p=f(!1),C=f(!1),a=f(""),b=f(0),l=f([]),x=f(!1),$=Y(()=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(m.value)),M=()=>k(this,null,function*(){var _;if(A())try{if(x.value=!0,a.value="",!$.value){a.value="Please enter a valid email address";return}(yield h("frappe.client.insert",{doc:{doctype:"Volunteer Company Mapper",volunteer_email:m.value,volunteer:y.cookie.name}}))&&(p.value=!0,D(),v.success("Verification email sent! Please check your inbox."))}catch(r){const c=((_=r==null?void 0:r.message)==null?void 0:_.toLowerCase())||"";c.includes("email not found in sva user")?(a.value="This email is not registered in our system. Please use your company email address.",v.error("Invalid company email address")):c.includes("no company associated")?(a.value="No company is associated with this email. Please contact your company administrator.",v.error("No company association found")):c.includes("already exists")?(a.value="This email is already mapped to a company. Please use a different email.",v.error("Email already mapped")):c.includes("verification required")?(p.value=!0,D(),v.info("A verification email has already been sent. Please check your inbox.")):c.includes("rate limit")?(a.value="Please wait a few minutes before requesting another verification email.",v.warning("Too many attempts. Please wait.")):(a.value="An error occurred while processing your request. Please try again later.",v.error("Failed to process request"),console.error("Company mapping error:",r))}finally{x.value=!1}}),T=()=>{b.value===0&&M()},D=()=>{b.value=300;const _=setInterval(()=>{b.value>0?b.value--:clearInterval(_)},1e3)},j=()=>{m.value="",p.value=!1,C.value=!1,a.value=""},R=_=>k(this,null,function*(){var r;try{yield h("frappe.client.delete",{doctype:"Volunteer Company Mapper",name:_}),v.success("Company mapping removed successfully!"),yield V()}catch(c){const S=((r=c==null?void 0:c.message)==null?void 0:r.toLowerCase())||"";S.includes("permission")?v.error("You do not have permission to remove this mapping"):S.includes("not found")?(v.error("This mapping no longer exists"),yield V()):(v.error("Failed to remove company mapping"),console.error("Remove mapping error:",c))}}),V=()=>k(this,null,function*(){var _;try{const r=yield h("frappe.client.get_list",{doctype:"Volunteer Company Mapper",fields:["name","volunteer_email","company_name","role_profile"],filters:{volunteer:y.cookie.name,is_email_verified:1}});l.value=r||[],C.value=l.value.length>0}catch(r){(((_=r==null?void 0:r.message)==null?void 0:_.toLowerCase())||"").includes("permission")?v.error("You do not have permission to view company mappings"):(v.error("Failed to fetch company mappings"),console.error("Fetch mappings error:",r)),l.value=[],C.value=!1}}),A=()=>(a.value="",m.value?$.value?m.value.includes("@gmail.com")||m.value.includes("@yahoo.com")||m.value.includes("@hotmail.com")?(a.value="Please use your company email address",!1):!0:(a.value="Please enter a valid email address",!1):(a.value="Email address is required",!1));return B(m,()=>{m.value&&!$.value?a.value="Please enter a valid email address":a.value=""}),H(()=>{V()}),(_,r)=>(i(),n("div",null,[r[5]||(r[5]=e("h2",{class:"text-xl font-semibold text-gray-700 mb-4"},"Company Mapping",-1)),C.value?(i(),n("div",ie,[e("div",{class:"flex justify-between items-center mb-4"},[r[4]||(r[4]=e("h3",{class:"text-lg font-medium text-gray-700"},"Mapped Companies",-1)),e("button",{onClick:j,class:"text-orange-500 hover:text-orange-600 text-sm"}," + Map New Company ")]),e("div",ue,[l.value.length===0?(i(),n("div",ce," No companies mapped yet ")):w("",!0),(i(!0),n(U,null,z(l.value,c=>(i(),n("div",{key:c.name,class:"flex justify-between items-center p-4 bg-gray-50 rounded-lg"},[e("div",null,[e("p",de,g(c.company_name),1),e("p",me,g(c.volunteer_email),1),e("p",pe,"Role: "+g(c.role_profile),1)]),e("button",{onClick:S=>R(c.name),class:"text-red-500 hover:text-red-600"}," Remove ",8,ve)]))),128))])])):(i(),n("div",ee,[e("div",te,[r[1]||(r[1]=e("label",{class:"block text-bodyh1 font-normal text-gray-700 mb-1"},[E(" Company Email "),e("span",{class:"text-red-500"},"*")],-1)),I(e("input",{"onUpdate:modelValue":r[0]||(r[0]=c=>m.value=c),type:"email",placeholder:"Enter your company email",disabled:p.value,class:"block w-full border border-gray-300 text-bodyh2 rounded py-2 px-3 focus:outline-none focus:ring focus:ring-orange-200"},null,8,ae),[[O,m.value]]),a.value?(i(),n("p",oe,g(a.value),1)):w("",!0)]),p.value?(i(),n("div",se,[r[2]||(r[2]=e("p",{class:"text-green-700 text-sm"},[e("span",{class:"font-medium"},"Verification email sent!"),e("br"),E(" Please check your email inbox and click the verification link to complete the company mapping process. ")],-1)),e("button",{onClick:T,class:"mt-2 text-orange-600 text-sm hover:text-orange-700",disabled:b.value>0},g(b.value>0?`Resend in ${b.value}s`:"Resend verification email"),9,re)])):w("",!0),e("div",null,[p.value?w("",!0):(i(),n("button",{key:0,onClick:M,disabled:!$.value||x.value,class:"bg-orange-500 text-white font-semibold py-2 px-4 rounded-sm hover:bg-orange-600 transition disabled:opacity-50 flex items-center gap-2"},[x.value?(i(),n("span",ne,r[3]||(r[3]=[e("svg",{class:"w-4 h-4",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})],-1)]))):w("",!0),E(" "+g(x.value?"Sending...":"Send Verification Email"),1)],8,le))])]))]))}},ye={class:"max-w-[1920px] mx-auto px-10 pt-[82px] pb-4 bg-gray-50"},be={class:"h-[261px] rounded-b-md bg-white"},_e={class:"relative"},ge={class:"absolute left-8 -bottom-8"},he={class:"w-32 h-32 rounded-full border-4 border-white overflow-hidden"},xe=["src"],we={key:1,class:"w-full h-full bg-gray-200 flex items-center justify-center text-[40px] text-gray-600"},ke={class:"pt-10 px-4"},Ce={class:"text-3xl font-medium"},Pe={class:"text-bodyh1 text-gray-600 mt-1"},$e={class:"bg-white rounded-lg shadow mt-4"},Me={class:"border-b border-gray-200"},Ve={class:"flex space-x-8 px-6","aria-label":"Tabs"},Se={class:"p-6"},qe={key:0},Te={class:"grid grid-cols-1 md:grid-cols-2 gap-4"},De={class:"block text-bodyh1 font-normal text-gray-700 mb-1"},Ie={key:0,class:"text-red-500 pt-2"},Ee=["onUpdate:modelValue","type","name","placeholder"],Ne=["max"],Fe=["onUpdate:modelValue","name"],je={value:"",disabled:""},Re=["value"],Ae={key:3,class:"text-red-500 text-[11px] mt-1"},Be={key:1},Ye={__name:"Updateprofile",setup(F){const h=N("call"),y=N("auth");J();const m=f(null),p=f("personal");console.log(p.value);const C=f({first_name:{label:"First Name",type:"text",required:!0,pattern:/^[A-Za-z]+$/,error_message:"Please enter a valid first name (letters only)"},last_name:{label:"Last Name",type:"text",required:!1},mobile_number:{label:"Phone No.",type:"text",required:!0,pattern:/^[0-9]{10}$/,error_message:"Invalid phone number "},custom_country:{label:"Country",type:"select",required:!0},custom_state:{label:"State",type:"select",required:!0},custom_city:{label:"City",type:"select",required:!0},custom_company:{label:"Company",type:"select",required:!1},custom_date_of_birth:{label:"Date of Birth",type:"date",required:!0,min:"1900-01-01",max:new Date().toISOString().split("T")[0],max:"maxDate",error_message:"Please select a valid date of birth"},title:{label:"Title",type:"text",placeholder:"Enter your title",required:!1}}),a=f({first_name:"",last_name:"",mobile_number:"",custom_country:"",custom_state:"",custom_city:"",custom_company:"",custom_date_of_birth:"",title:""}),b=f(new Date().toISOString().split("T")[0]),l=f({}),x=f([]),$=f([]),M=f([]),T=f([]),D=()=>k(this,null,function*(){const o=yield h("mykartavya.controllers.api.country_data");x.value=o||[]}),j=()=>k(this,null,function*(){if(!a.value.custom_country)return;const o=yield h("mykartavya.controllers.api.state_data",{country:a.value.custom_country});$.value=o||[]}),R=()=>k(this,null,function*(){if(!a.value.custom_state)return;const o=yield h("mykartavya.controllers.api.city_data",{state:a.value.custom_state});M.value=o||[]}),V=()=>k(this,null,function*(){const o=yield h("mykartavya.controllers.api.company_data");T.value=o||[]});B(()=>a.value.custom_country,j),B(()=>a.value.custom_state,R);const A=()=>k(this,null,function*(){let o=yield h("mykartavya.controllers.api.sva_user_data");o&&o.length>0&&(a.value=o[0],a.value.custom_company&&p.value==="company"&&(p.value="personal"))}),_=()=>{var t;l.value={};let o=!0;for(const s in a.value){const u=C.value[s],d=a.value[s];if(u){if(u.required&&!d&&(l.value[s]=`${u.label} is required.`,o=!1,m.value||(m.value=s)),s==="mobile_number"){const P=d==null?void 0:d.trim();(t=u.pattern)!=null&&t.test(P)||((P==null?void 0:P.length)===0?l.value[s]="Phone number is required.":(P==null?void 0:P.length)!==10?l.value[s]="Phone number must be exactly 10 digits.":l.value[s]=u.error_message,o=!1)}console.log(d),s==="first_name"&&u.pattern&&!u.pattern.test(d)&&(l.value[s]=u.error_message,o=!1),s==="last_name"&&u.pattern&&!u.pattern.test(d)&&(l.value[s]=u.error_message,o=!1),s==="custom_date_of_birth"&&(d?new Date(d)>new Date?(l.value[s]="You cannot select a future date.",o=!1):delete l.value[s]:(l.value[s]="Date of birth is required.",o=!1))}}return o},r=()=>k(this,null,function*(){if(!_()){S();return}try{let o=yield h("mykartavya.controllers.api.update_sva_user",{data:{first_name:a.value.first_name,last_name:a.value.last_name||"",mobile_number:a.value.mobile_number,custom_date_of_birth:a.value.custom_date_of_birth,custom_country:a.value.custom_country,custom_state:a.value.custom_state,custom_city:a.value.custom_city,custom_company:a.value.custom_company||""}});o.status==200?v.success("Profile updated successfully!",{autoClose:3e3}):v.error(o.message||"Failed to update profile.")}catch(o){v.error("An error occurred while updating the profile.")}}),c=o=>{switch(o){case"custom_country":return x.value.map(t=>({name:t.name,label:t.label||t.name}));case"custom_state":return $.value.map(t=>({name:t.name,label:t.state_name||t.name}));case"custom_city":return M.value.map(t=>({name:t.name,label:t.district_name||t.name}));case"custom_company":return T.value.map(t=>({name:t.name,label:t.company_name||t.name}));default:return[]}};H(()=>{D(),V(),A(),localStorage.getItem("updateprofile")=="true"&&(v.error("Please update your profile to continue.",{autoClose:3e3}),localStorage.removeItem("updateprofile"))});const S=()=>k(this,null,function*(){if(m.value){yield W();const o=document.querySelector(`[name="${m.value}"]`);o&&(o.scrollIntoView({behavior:"smooth",block:"center"}),o.focus()),m.value=null}});return(o,t)=>(i(),n("div",ye,[e("div",be,[e("div",_e,[t[7]||(t[7]=e("div",{class:"w-full h-[152px]"},[e("img",{src:X,alt:"Banner",class:"w-full h-full object-cover"})],-1)),e("div",ge,[e("div",he,[q(y).user_image?(i(),n("img",{key:0,src:q(y).user_image,alt:"Profile",class:"w-full h-full object-cover"},null,8,xe)):(i(),n("div",we,g(q(y).cookie.full_name.charAt(0)),1))])])]),e("div",ke,[e("h1",Ce,g(q(y).cookie.full_name),1),e("p",Pe,g(q(y).cookie.user_id),1)])]),e("div",$e,[e("div",Me,[e("nav",Ve,[e("button",{onClick:t[0]||(t[0]=s=>p.value="personal"),class:L([p.value==="personal"?"border-orange-500 text-orange-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300","whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"])}," Personal Info ",2),a.value.custom_company?w("",!0):(i(),n("button",{key:0,onClick:t[1]||(t[1]=s=>p.value="company"),class:L([p.value==="company"?"border-orange-500 text-orange-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300","whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"])}," Company Mapping ",2))])]),e("div",Se,[p.value==="personal"?(i(),n("div",qe,[t[15]||(t[15]=e("h2",{class:"text-xl font-semibold text-gray-700 mb-4"},"Personal Info",-1)),e("form",{onSubmit:G(r,["prevent"])},[e("div",Te,[(i(!0),n(U,null,z(C.value,(s,u)=>(i(),n("div",{key:u},[e("label",De,[E(g(s.label)+" ",1),s.required?(i(),n("span",Ie,"*")):w("",!0)]),u!=="custom_date_of_birth"&&s.type!=="select"?I((i(),n("input",{key:0,"onUpdate:modelValue":d=>a.value[u]=d,type:s.type,name:u,placeholder:s.placeholder,class:"block w-full border border-gray-300 text-bodyh2 rounded py-2 px-3 focus:outline-none focus:ring focus:ring-orange-200"},null,8,Ee)),[[K,a.value[u]]]):u==="custom_date_of_birth"?I((i(),n("input",{key:1,"onUpdate:modelValue":t[2]||(t[2]=d=>a.value.custom_date_of_birth=d),type:"date",name:"custom_date_of_birth",max:b.value,class:"block w-full border border-gray-300 text-bodyh2 rounded py-2 px-3 focus:outline-none focus:ring focus:ring-orange-200"},null,8,Ne)),[[O,a.value.custom_date_of_birth]]):w("",!0),s.type==="select"?I((i(),n("select",{key:2,"onUpdate:modelValue":d=>a.value[u]=d,name:u,class:"block w-full border border-gray-300 text-bodyh2 rounded py-2 px-3 focus:outline-none focus:ring focus:ring-orange-200"},[e("option",je,"Select "+g(s.label),1),(i(!0),n(U,null,z(c(u),d=>(i(),n("option",{key:d.name,value:d.name},g(d.label||d.name),9,Re))),128))],8,Fe)),[[Q,a.value[u]]]):w("",!0),l.value[u]?(i(),n("p",Ae,g(l.value[u]),1)):w("",!0)]))),128)),e("div",null,[t[10]||(t[10]=e("label",{class:"block text-bodyh1 font-normal text-gray-700 mb-1"},"Add CV",-1)),e("div",{class:"flex flex-col items-center justify-center border-2 border-dashed border-orange-300 text-orange-500 p-4 rounded cursor-pointer",onClick:t[4]||(t[4]=s=>o.cvInput.click())},[t[8]||(t[8]=e("svg",{class:"w-10 h-10 mb-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24","stroke-width":"2"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M7 3h10M7 3a2 2 0 00-2 2v2m2-2h10m0 0a2 2 0 012 2v2m-2-2H7m13 8V8H4v8a2 2 0 002 2h12a2 2 0 002-2z"})],-1)),t[9]||(t[9]=e("span",{class:"text-bodyh1"},"Click to upload or drag and drop",-1)),e("input",{ref:"cvInput",type:"file",accept:".pdf,.doc,.docx",class:"hidden",onChange:t[3]||(t[3]=(...s)=>o.onCvSelected&&o.onCvSelected(...s))},null,544)])]),e("div",null,[t[13]||(t[13]=e("label",{class:"block text-bodyh1 font-normal text-gray-700 mb-1"},"Add Portfolio",-1)),e("div",{class:"flex flex-col items-center justify-center border-2 border-dashed border-orange-300 text-orange-500 p-4 rounded cursor-pointer",onClick:t[6]||(t[6]=s=>o.portfolioInput.click())},[t[11]||(t[11]=e("svg",{class:"w-10 h-10 mb-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24","stroke-width":"2"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M7 3h10M7 3a2 2 0 00-2 2v2m2-2h10m0 0a2 2 0 012 2v2m-2-2H7m13 8V8H4v8a2 2 0 002 2h12a2 2 0 002-2z"})],-1)),t[12]||(t[12]=e("span",{class:"text-sm"},"Click to upload or drag and drop",-1)),e("input",{ref:"portfolioInput",type:"file",accept:".pdf,.doc,.docx",class:"hidden",onChange:t[5]||(t[5]=(...s)=>o.onPortfolioSelected&&o.onPortfolioSelected(...s))},null,544)])])]),t[14]||(t[14]=e("div",{class:"mt-6"},[e("button",{type:"submit",class:"bg-orange-500 text-white font-semibold py-2 px-4 rounded-sm hover:bg-orange-600 transition"}," UPDATE ")],-1))],32)])):w("",!0),p.value==="company"&&!a.value.custom_company?(i(),n("div",Be,[Z(fe)])):w("",!0)])])]))}};export{Ye as default};
